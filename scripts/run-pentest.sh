#!/bin/bash

CONFIG_BUCKET=${CONFIG_BUCKET:-$1}
if [[ -z "${CONFIG_BUCKET}" ]]; then
  echo "No configuration available"
  exit 2
fi

aws s3 cp s3://${CONFIG_BUCKET}/pentest.vars /tmp
. /tmp/pentest.vars
rm -f /tmp/pentest.vars

TMP=$(mktemp -d)
cd ${TMP}
aws s3 cp s3://${REPORT_BUCKET}/${IP_LIST} ${TMP}/

wpscan -o ./reports/wpscan.out -f json --url ${WPSCAN_HOST} --api-token ${WPSCAN_API_TOKEN}

sudo msfdb reinit
sudo msfconsole -o ./reports/gather_report -x "db_nmap -A -oA ${TMP}/reports/nmap_scap -iL ${IP_LIST}; exit"
sudo msfconsole -o ./reports/port_report -x "services; exit"

now=$(date '+%Y%m%d')
aws s3 cp ./reports/ s3://${REPORT_BUCKET}/${now}/ --recursive
${NOTIFIER} s3://${REPORT_BUCKET}/${now}/

rm -rf ${TMP}
