#!/bin/bash

set -xe -o pipefail

DIR=$( cd $(dirname ${BASH_SOURCE[0]}) > /dev/null; pwd )
CONFIG_BUCKET=${CONFIG_BUCKET:-$1}
if [[ -z "${CONFIG_BUCKET}" ]]; then
  echo "No configuration available"
  exit 2
fi

aws s3 cp s3://${CONFIG_BUCKET}/pentest.vars /tmp
. /tmp/pentest.vars
rm -f /tmp/pentest.vars

TMP=$(mktemp -d)
cd ${TMP}
mkdir reports
${DIR}/collect-ips.sh ${DNS_DOMAIN}

wpscan -o ./reports/wpscan.out -f json --url ${WPSCAN_HOST} --api-token ${WPSCAN_API_TOKEN} || true

sudo msfdb reinit
sudo msfconsole -o ./reports/gather_report -x "db_nmap -A -oX ${TMP}/reports/nmap_scan.xml -iL ${IP_LIST}; exit"
sudo msfconsole -o ./reports/port_report -x "services; exit"

now=$(date '+%Y%m%d')
aws s3 cp ./reports/ s3://${REPORT_BUCKET}/${now}/ --recursive
${NOTIFIER} s3://${REPORT_BUCKET}/${now}/

cd
rm -rf ${TMP}
