#!/bin/bash

exec > /tmp/log.$$.txt 2>&1
set -xe -o pipefail

DIR=$( cd $(dirname ${BASH_SOURCE[0]}) > /dev/null; pwd )
CONFIG_BUCKET=${CONFIG_BUCKET:-$1}
if [[ -z "${CONFIG_BUCKET}" ]]; then
  echo "No configuration available"
  exit 2
fi

aws s3 cp s3://${CONFIG_BUCKET}/pentest.vars /tmp
. /tmp/pentest.vars
rm -f /tmp/pentest.vars

TMP=$(mktemp -d)
cd ${TMP}
mkdir reports
cd reports
${DIR}/collect-ips.sh ${DNS_DOMAIN}

wpscan -o ${TMP}/reports/wpscan.out -f json --url ${WPSCAN_HOST} --api-token ${WPSCAN_API_TOKEN} || true

nmap -A --webxml -oA ${TMP}/reports/nmap_scan -iL ${TMP}/reports/${IP_LIST}

now=$(date '+%Y%m%d')
cp /tmp/log.$$.txt ${TMP}/reports/run.log
aws s3 cp ${TMP}/reports/ s3://${REPORT_BUCKET}/${now}/ --recursive
${NOTIFIER} s3://${REPORT_BUCKET}/${now}/

cd
rm -rf ${TMP}
