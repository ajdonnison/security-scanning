#!/bin/bash

set -xe -o pipefail

CONFIG_BUCKET=${CONFIG_BUCKET:-$1}
if [[ -z "${CONFIG_BUCKET}" ]]; then
  echo "No configuration available"
  exit 2
fi

aws s3 cp s3://${CONFIG_BUCKET}/pentest.vars /tmp
. /tmp/pentest.vars
rm -f /tmp/pentest.vars

TMP=$(mktemp -d)
cd ${TMP}

wpscan -o /reports/wpscan.out -f json --url ${WPSCAN_HOST} --api-token ${WPSCAN_API_TOKEN}

sudo msfconsole -o /reports/gather_report -x "db_nmap -A -oA /reports/nmap_scap -iL ${IP_LIST}; exit"
sudo msfconsole -o /reports/port_report -x "services; exit"

now=$(date '+%Y%m%d')
aws s3 cp /reports/* s3://${REPORT_BUCKET}/${now}/
${NOTIFIER} s3://${REPORT_BUCKET}/${now}/

rm -rf ${TMP}
